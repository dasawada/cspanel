<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android WebView Forensics</title>
    <style>
        body { font-family: monospace; background: #222; color: #ddd; padding: 20px; }
        .box { padding: 15px; border: 1px solid #555; margin-bottom: 20px; border-radius: 6px; }
        .pass { border-color: #00E676; background: #003311; color: #00E676; }
        .fail { border-color: #FF5252; background: #330000; color: #FF5252; }
        .label { font-size: 0.8rem; color: #888; }
        .val { font-size: 1.1rem; font-weight: bold; word-break: break-all; }
    </style>
</head>
<body>
    <h3>ğŸ¤– Android ç’°å¢ƒæ·±åº¦é‘‘è­˜</h3>
    <div id="result">åˆ†æä¸­...</div>

    <script>
        (function() {
            const ua = navigator.userAgent;
            const evidence = [];
            let isCleanBrowser = false;
            let rejectReason = null;

            // === 1. Client Hints æª¢æ¸¬ (Android æœ€å¼·è­‰æ“š) ===
            // ç¾ä»£ Android è¨­å‚™é€šå¸¸æ”¯æ´æ­¤ APIï¼Œå®ƒæ¯” UA å­—ä¸²æ›´èª å¯¦
            let hintBrand = "Not Supported";
            let isHintWebView = false;
            
            if (navigator.userAgentData) {
                const brands = navigator.userAgentData.brands || [];
                // è½‰ç‚ºå­—ä¸²æ–¹ä¾¿é¡¯ç¤º
                hintBrand = brands.map(b => `${b.brand} (${b.version})`).join(', ');
                
                // æª¢æŸ¥æ˜¯å¦åŒ…å« "Android WebView" æˆ– "WebView"
                isHintWebView = brands.some(b => /Android WebView|WebView/i.test(b.brand));
                if (isHintWebView) {
                    evidence.push("âŒ Client Hints æ¨™ç¤ºç‚º WebView");
                }
            }

            // === 2. 'wv' æ¨™è¨˜æª¢æ¸¬ (Android å‚³çµ±è­‰æ“š) ===
            // åœ¨ UA string ä¸­ï¼Œ"; wv" æ˜¯ WebView çš„æ˜ç¢ºæ¨™è­˜
            // æ ¼å¼é€šå¸¸ç‚º: ... Android 10; Mobile; wv) ...
            const hasWVToken = /; wv\)/.test(ua) || /; wv;/.test(ua);
            if (hasWVToken) {
                evidence.push("âŒ User Agent åŒ…å« '; wv' æ¨™è¨˜");
            }

            // === 3. Version/Chrome é›™é‡å­˜åœ¨æª¢æ¸¬ (é‚è¼¯é™·é˜±) ===
            // ç´”ç¨® Chrome Mobile: "Chrome/110.0..." (æ²’æœ‰ Version/)
            // WebView: "Version/4.0 Chrome/110.0..." (æœ‰ Version/)
            // ä¸‰æ˜Ÿç€è¦½å™¨: "Version/4.0 Chrome/... SamsungBrowser/..." (æœ‰ Version ä¹Ÿæœ‰ Samsung)
            const hasVersion = /Version\//.test(ua);
            const hasChrome = /Chrome\//.test(ua);
            const hasSamsung = /SamsungBrowser/.test(ua);
            const hasFirefox = /Firefox/.test(ua);

            let isStockWebView = false;
            if (hasVersion && hasChrome && !hasSamsung) {
                isStockWebView = true;
                evidence.push("âŒ åµæ¸¬åˆ° Version/ èˆ‡ Chrome/ åŒæ™‚å­˜åœ¨ (å…¸å‹çš„ Android WebView ç‰¹å¾µ)");
            }

            // === 4. æ˜ç¢ºçš„ App é—œéµå­— ===
            const appKeywords = /Line\/|FBAV|FBAN|Instagram|GSA\/|MiuiBrowser|HeyTapBrowser/;
            const isKnownApp = appKeywords.test(ua);
            if (isKnownApp) {
                evidence.push("âŒ å‘½ä¸­å·²çŸ¥ In-App é—œéµå­—é»‘åå–®");
            }

            // === CCT (Chrome Custom Tab) æ·±åº¦åµæ¸¬ ===
            // é€™æ˜¯å”¯ä¸€èƒ½å€åˆ† "Chrome App" èˆ‡ "Google App å‘¼å«çš„ Chrome" çš„æ–¹æ³•
            const referrer = document.referrer || "";
            const isAndroidAppSource = referrer.startsWith("android-app://");

            // ç‰¹ä¾‹ï¼šGoogle App çš„ Referrer ç‰¹å¾µ
            // å¸¸è¦‹å€¼ï¼šandroid-app://com.google.android.googlequicksearchbox/
            const isGoogleApp = referrer.includes("com.google.android.googlequicksearchbox");

            if (isAndroidAppSource) {
                // å³ä½¿ UA èªªæ˜¯ Chromeï¼Œä½†ä¾†æºæ˜¯ Appï¼Œåˆ¤å®šç‚º In-App ç’°å¢ƒ
                isCleanBrowser = false;
                rejectReason = `Detected Chrome Custom Tab launched by: ${referrer}`;
                evidence.push(`âŒ ä¾†æºç•°å¸¸ (Referrer): ${referrer}`);
            }

            // === è¼”åŠ©åˆ¤å®šï¼šæ­·å²ç´€éŒ„å­¤å³¶ ===
            // æ¨™æº– Chrome ä½¿ç”¨è€…é€šå¸¸æœƒæœ‰ç€è¦½ç´€éŒ„ï¼ŒIn-App é–‹å•Ÿé€šå¸¸æ˜¯ 1 æˆ– 2
            if (history.length <= 1 && isAndroidAppSource) {
                evidence.push("âŒ History Length æ¥µçŸ­ï¼Œç¬¦åˆ In-App è¡Œç‚º");
            }

            // === 5. åˆ¤æ±ºé‚è¼¯ (Decision Matrix) ===
            
            if (isHintWebView || hasWVToken || isKnownApp) {
                // çµ•å°æ­»åˆ‘
                isCleanBrowser = false;
                rejectReason = "In-App WebView (Confirmed)";
            } else if (isStockWebView) {
                // é‚è¼¯æ­»åˆ‘
                isCleanBrowser = false;
                rejectReason = "Generic Android WebView";
            } else if (hasSamsung || hasFirefox) {
                // ä¸‰æ˜Ÿæˆ–ç«ç‹ (ç™½åå–®)
                isCleanBrowser = true;
                evidence.push("âœ… è­˜åˆ¥ç‚º Samsung Internet æˆ– Firefox");
            } else if (hasChrome && !hasVersion) {
                // ç´”ç¨® Chrome
                isCleanBrowser = true;
                evidence.push("âœ… è­˜åˆ¥ç‚ºæ¨™æº– Chrome Mobile (ç„¡ Version æ¨™è¨˜)");
            } else {
                // ç°è‰²åœ°å¸¶ï¼Œé è¨­æ”¾è¡Œä½†æ¨™è¨˜
                isCleanBrowser = true; 
                evidence.push("âš ï¸ æœªçŸ¥ç€è¦½å™¨ (æœªå‘½ä¸­ WebView ç‰¹å¾µï¼Œæš«æ™‚æ”¾è¡Œ)");
            }

            // === 6. è¼¸å‡º ===
            const resultBox = document.getElementById('result');
            const statusClass = isCleanBrowser ? 'pass' : 'fail';
            const statusText = isCleanBrowser ? 'âœ… æ¨™æº–ç€è¦½å™¨ (WebRTC Ready)' : 'â›” è«‹åˆ‡æ›ç€è¦½å™¨ (WebView Detected)';

            resultBox.innerHTML = `
                <div class="box ${statusClass}">
                    <h2>${statusText}</h2>
                    <div>${rejectReason || "ç’°å¢ƒç¬¦åˆ WebRTC æ¨™æº–"}</div>
                </div>

                <div class="box">
                    <div class="label">Client Hints (Brands):</div>
                    <div class="val">${hintBrand}</div>
                </div>

                <div class="box">
                    <div class="label">Critical Signals:</div>
                    <ul>
                        ${evidence.map(e => `<li>${e}</li>`).join('')}
                    </ul>
                </div>

                <div class="box">
                    <div class="label">Raw User Agent:</div>
                    <div class="val" style="font-size: 0.8rem">${ua}</div>
                </div>
            `;
        })();
    </script>
</body>
</html>
