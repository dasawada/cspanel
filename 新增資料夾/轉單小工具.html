<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device=1.0">
  <title>轉單小幫手</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="favicon.ico">
  <style>
html,body { margin:0; height:100%; }

.auth-wrapper {
  position: fixed;
  inset: 0;
  display: grid;
  place-items: center;
  padding: 0;
  background:
    radial-gradient(circle at 15% 20%, rgba(74,144,226,.15), transparent 60%),
    radial-gradient(circle at 85% 70%, rgba(125,206,160,.18), transparent 65%),
    #f5f7fb;
  box-sizing: border-box;
  z-index: 1000; /* 確保登入層在最上方，隱藏後解除影響 */
}

.auth-card {
  width: 380px;
  margin: 0;
}

/* 其餘原有的 auth-card 內部細節樣式保持不動 */
    .active-link {
      background-color: #4a90e2;
      color: white;
    }
    /* 容器樣式 */
    .fudausearch-container {
    width: 400px;
    height: auto;
    font-size: 12px;
    color: #4d4d4d;
    border: 1px solid #ccc;
    border-radius: 10px;
    background-color: white;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 6px 20px rgba(0, 0, 0, 0.1);
    box-sizing: border-box;
    gap: 10px;
    padding-bottom: 10px;
}

/* 建議選單樣式 */
.fudausearch-suggestions {
    position: absolute;
    top: 100%;
    left: 10px;
    width: 90%;
    background-color: #fff;
    border: 1px solid #ccc;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    z-index: 999;
    display: none;
}

.fudausearch-suggestion-item {
    padding: 8px;
    cursor: pointer;
    font-size: 14px;
}

.fudausearch-suggestion-item:hover {
    background-color: #f0f0f0;
}
.fudausearch-button {
  background-color: #f0f0f0;
  padding: 2px 6px;
  border: 1px solid #bfbfbf;
  border-radius: 4px;
  cursor: pointer;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
  transition: background-color 0.1s ease;
  line-height: 1.3;
}
/* 已複製樣式 */
.fudausearch-button.copied {
    color: white;
    background-color: #28a745;
    border-color: #28a745;
  }
  
    /* 學務部按鈕特殊樣式 */
  .fudausearch-button-special {
    background-color: #df532d; 
    color: white;             
  }

  .fudausearch-button-special:hover {
    background-color: #B53A18;
    color: white;
  }

  .fudausearch-button-paikezu {
    background-color: #211898; 
    color: white;             
  }

  .fudausearch-button-paikezu:hover {
    background-color: #312B7A;
    color: white;
  }
  
  .fudausearch-button-kefugon {
    background-color: #484661; 
    color: white;             
  }

  .fudausearch-button-kefugon:hover {
    background-color: #2A292E;
    color: white;
  }
  .fudausearch-button-groupnumber {
    background-color: #078eda;
    color: white;
  }
  .fudausearch-button-groupnumber:hover {
    background-color: #163c94;
    color: white;
  }
/* 包裹輸入框與按鈕的容器 */
.fudausearch-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  margin-bottom: 5px;
  padding: 5px 10px 0px 10px;
}

#fudausearch-input {
  flex: 1;
}

/* 清除按鈕樣式 */
.fudausearch-clear-btn {
  position: absolute;
  right: 15px;
  background-color: transparent;
  border: none;
  font-size: 15px;
  color: #aaa;
  cursor: pointer;
  width: 15px;
}

.fudausearch-clear-btn:hover {
  color: #000;
}
.draggable-handle{color: darkgrey;}

    /* Auth (Login) Unified Style */
    .auth-wrapper{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(circle at 15% 20%,rgba(74,144,226,.15),transparent 60%),
        radial-gradient(circle at 85% 70%,rgba(125,206,160,.18),transparent 65%),
        #f5f7fb;
      padding:32px 16px;
      box-sizing:border-box;
    }
    .auth-card{
      width:380px;
      background:#ffffff;
      border:1px solid #dfe3ea;
      border-radius:18px;
      box-shadow:0 4px 12px rgba(0,0,0,.08),0 2px 4px rgba(0,0,0,.05);
      padding:32px 34px 30px;
      position:relative;
      display:flex;
      flex-direction:column;
      gap:18px;
      animation:cardIn .38s cubic-bezier(.32,.72,.29,.99);
    }
    @keyframes cardIn{
      from{opacity:0;transform:translateY(14px) scale(.97)}
      to{opacity:1;transform:translateY(0) scale(1)}
    }
    .auth-card:before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:18px;
      pointer-events:none;
      background:
        linear-gradient(140deg,rgba(74,144,226,.25),rgba(255,255,255,0) 45%),
        linear-gradient(300deg,rgba(255,166,0,.18),rgba(255,255,255,0) 55%);
      mix-blend-mode:overlay;
    }
    .auth-title{
      margin:0;
      font-size:22px;
      font-weight:600;
      letter-spacing:.5px;
      color:#2f3a4a;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .auth-sub{
      margin:-10px 0 8px;
      font-size:13px;
      line-height:1.5;
      color:#5b6472;
    }
    .auth-form{display:flex;flex-direction:column;gap:14px;}
    .input-group{display:flex;flex-direction:column;gap:6px;}
    .input-label{
      font-size:12px;
      font-weight:600;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:#5a6575;
    }
    .auth-input{
      height:42px;
      padding:0 14px;
      font-size:14px;
      border:1px solid #cfd6df;
      border-radius:10px;
      background:#fff;
      transition:.18s border-color,.18s box-shadow,.18s background-color;
      font-family:inherit;
    }
    .auth-input:focus{
      outline:none;
      border-color:#4a90e2;
      box-shadow:0 0 0 3px rgba(74,144,226,.25);
    }
    .auth-input::placeholder{color:#b0b8c2;}
    .auth-button{
      height:44px;
      border:none;
      border-radius:11px;
      background:linear-gradient(135deg,#4a90e2,#3575c8);
      color:#fff;
      font-size:15px;
      font-weight:600;
      letter-spacing:.5px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      box-shadow:0 4px 10px -2px rgba(53,117,200,.55),0 2px 4px rgba(0,0,0,.08);
      transition:.22s background,.22s box-shadow,.22s transform;
    }
    .auth-button:hover{
      background:linear-gradient(135deg,#5aa0f0,#3575c8);
      box-shadow:0 6px 14px -2px rgba(53,117,200,.6),0 3px 6px rgba(0,0,0,.09);
      transform:translateY(-2px);
    }
    .auth-button:active{
      transform:translateY(0);
      box-shadow:0 3px 8px -2px rgba(53,117,200,.55),0 2px 4px rgba(0,0,0,.08);
    }
    .auth-error{
      min-height:18px;
      font-size:12.5px;
      color:#d9534f;
      font-weight:500;
      letter-spacing:.4px;
      word-break:break-all;
    }
    .auth-footer{
      margin-top:4px;
      font-size:11.5px;
      color:#8a949f;
      text-align:center;
      line-height:1.5;
    }
    .auth-divider{
      height:1px;
      background:linear-gradient(90deg,rgba(0,0,0,0),rgba(0,0,0,.12) 10%,rgba(0,0,0,.12) 90%,rgba(0,0,0,0));
      margin:4px 0 2px;
    }
    .auth-badge{
      position:absolute;
      top:10px;
      right:12px;
      font-size:10px;
      font-weight:600;
      letter-spacing:.7px;
      background:#eef4fb;
      color:#3470b3;
      padding:4px 8px;
      border-radius:20px;
      box-shadow:inset 0 0 0 1px #d0e2f3;
    }
    .auth-logo{
      width:34px;
      height:34px;
      border-radius:12px;
      background:linear-gradient(135deg,#4a90e2 15%,#50c9ce);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:17px;
      font-weight:600;
      letter-spacing:-.5px;
      box-shadow:0 4px 10px -2px rgba(74,144,226,.55),0 2px 4px rgba(0,0,0,.08);
    }
    .auth-inline{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .auth-mini-note{
      margin-top:2px;
      font-size:11px;
      color:#6d7784;
      line-height:1.4;
    }
    @media (max-width:480px){
      .auth-card{width:100%;padding:26px 24px 26px;border-radius:16px;}
      .auth-title{font-size:20px;}
    }
  </style>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { initFudausearchPanel, clearFudausearchPanel } from '../script/fusearch-panel.js';

    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyAhgA5nFE3bLTVyudYjKctSpnTCIgORg8M",
      authDomain: "cstoolsapi.firebaseapp.com",
      projectId: "cstoolsapi"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    window.auth = auth;
    window.onAuthStateChanged = onAuthStateChanged;

    document.addEventListener('DOMContentLoaded', () => {
      let currentUser = null;
      
      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        
        if (user) {
          loginContainer.style.display = 'none';
          appContainer.style.display = 'block';
          user.getIdToken().then(token => {
            window.userToken = token;
            // 在取得 token 後再初始化面板，確保 API 呼叫有有效權杖
            initFudausearchPanel('fudausearch-container');
          });
          
          // ===== 新增: 背景自動更新 token (每 50 分鐘) =====
          if (window.tokenRefreshInterval) {
            clearInterval(window.tokenRefreshInterval);
          }
          
          window.tokenRefreshInterval = setInterval(async () => {
            try {
              const newToken = await user.getIdToken(true);
              window.userToken = newToken;
              console.log('✅ Token 已自動更新');
            } catch (error) {
              console.error('❌ 背景更新 token 失敗:', error);
            }
          }, 50 * 60 * 1000); // 50 分鐘
          
        } else {
          loginContainer.style.display = 'block';
          appContainer.style.display = 'none';
          
          // 登出時清除定時器
          if (window.tokenRefreshInterval) {
            clearInterval(window.tokenRefreshInterval);
          }
          // 登出時清除 fudausearch 面板資料與綁定
          clearFudausearchPanel('fudausearch-container');
        }
      });

      // 使用 Firebase Client-Side SDK 登入
      document.getElementById('login-btn').addEventListener('click', async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('login-error');
        
        errorDiv.textContent = '';
        
        if (!email || !password) {
          errorDiv.textContent = '請輸入 Email 和密碼';
          return;
        }
        
        try {
          // 使用 Firebase SDK 直接登入
          await signInWithEmailAndPassword(auth, email, password);
          // onAuthStateChanged 會自動觸發，不需手動處理
        } catch (error) {
          console.error('Login error:', error);
          let errorMessage = '登入失敗';
          
          switch (error.code) {
            case 'auth/invalid-email':
              errorMessage = 'Email 格式錯誤';
              break;
            case 'auth/user-not-found':
              errorMessage = '找不到此使用者';
              break;
            case 'auth/wrong-password':
              errorMessage = '密碼錯誤';
              break;
            case 'auth/invalid-credential':
              errorMessage = '帳號或密碼錯誤';
              break;
            case 'auth/too-many-requests':
              errorMessage = '登入嘗試次數過多，請稍後再試';
              break;
            default:
              errorMessage = error.message || '登入過程發生錯誤';
          }
          
          errorDiv.textContent = errorMessage;
        }
      });
    });
  </script>
</head>
<body>
  <!-- 重構登入介面 -->
  <div id="login-container" class="auth-wrapper" style="display:block;">
    <div class="auth-card">
      <div class="auth-badge">INTERNAL</div>
      <div class="auth-inline">
        <div class="auth-logo">OC</div>
        <h2 class="auth-title">轉單小幫手</h2>
      </div>
      <p class="auth-sub">請使用授權帳號登入。</p>

      <form class="auth-form" onsubmit="return false;">
        <div class="input-group">
          <label for="email" class="input-label">Email</label>
          <input type="email" id="email" class="auth-input" placeholder="請輸入授權帳號" autocomplete="username">
        </div>
        <div class="input-group">
          <label for="password" class="input-label">Password</label>
            <input type="password" id="password" class="auth-input" placeholder="••••••••" autocomplete="current-password">
        </div>
        <button id="login-btn" type="button" class="auth-button">
          登入
        </button>
        <div id="login-error" class="auth-error"></div>
      </form>

      <div class="auth-divider"></div>
      <div class="auth-footer">
        僅限授權內部人員使用 · 未經授權請勿嘗試登入
        <div class="auth-mini-note">登入成功後自動跳轉工具主畫面</div>
      </div>
    </div>
  </div>

  <!-- App Container (hidden until authenticated) -->
  <div id="app-container" style="display: none;">
    <div class="fudausearch-container" id="fudausearch-container" style="z-index: 998;">
      <div class="fudausearch-drag-handle" id="fudausearch-drag-handle">
          職代是誰 (⁎⁍̴̛ᴗ⁍̴̛⁎)
      </div>
      <button class="fudausearch-fixed-button" id="fudausearch-fixed-button" style="display: none;">學務部</button>
      <div class="fudausearch-input-wrapper">
          <input type="text" id="fudausearch-input" placeholder="輔導職代、顧問組長查詢" style="padding:2px 6px;font-size: 13px;" autocomplete="off" />
          <button class="fudausearch-clear-btn" id="fudausearch-clear-btn">x</button>
          <div id="fudausearch-suggestions" class="fudausearch-suggestions"></div>
      </div>
      <div id="fudausearch-results" style="padding: 0 10px;"></div>
  </div>
  <script type="module" src="../script/fusearch-panel.js"></script>
  <script type="module">
  import { makeDraggable } from '../script/draggable.js';
  import { DealClient } from '../script/deal-composite-client.js';
  
  // 設定全域 DealClient 實例
  window.dealClient = new DealClient({ includeRaw: true });

  document.addEventListener('DOMContentLoaded', () => {
  const panel = document.getElementById('fudausearch-container');
  const handle = panel.querySelector('.fudausearch-drag-handle');
  makeDraggable(panel, handle, { left: 300, top: 185, color: '#a9bcc7'});
  });
  </script>
    <div class="container">
      <!-- Background Decorations -->
      <div class="bg-decoration bg-decoration-1"></div>
      <div class="bg-decoration bg-decoration-2"></div>

      <!-- Left Panel -->
      <div class="panel">
        <div class="search-container">
          <input type="text" id="dealId" class="search-input" placeholder="輸入Deal ID">
          <button id="searchButton" class="search-button">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="M21 21l-4.35-4.35"/>
            </svg>
            搜尋
          </button>
        </div>
        <div class="result-container">
          <pre id="result" class="result-text">等待搜尋...</pre>
        </div>
        <!-- 新增連結區塊，固定顯示在左側下方 -->
        <div id="linksContainer" class="links-container"></div>
      </div>

      <!-- Right Panel -->
      <div class="panel-container">
        <!-- Table Container -->
        <div class="panel table-container">
          <div class="table-header">
      <div class="title-group-left">
            <h2 class="table-title">訂單資料表</h2>
      <button id="helpButton" class="help-button" title="說明">?</button>
      </div>
            <div class="table-actions">
              <button class="button button-primary" id="copyButton">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                  <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                </svg>
                複製
              </button>
      <button class="button button-primary" id="generateButton">
        <!-- 可複用圖示或僅顯示文字 -->
        生成
      </button>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>轉單日</th>
                  <th>交編</th>
                  <th>聯絡人</th>
                  <th>狀態</th>
                  <th>顧問</th>
                  <th>學員名</th>
                  <th>立約人</th>
                  <th>科目</th>
                  <th>方案</th>
                  <th>J</th>
                  <th>輔導</th>
                  <th>組別</th>
                  <th>金額</th>
                  <th>OCID</th>
                </tr>
              </thead>
              <tbody>
                <tr id="dataRow">
                  <td><input type="text" class="cell-input" id="colA" placeholder="mm/dd"></td>
                  <td><input type="text" class="cell-input" id="colB" placeholder="交易編號"></td>
                  <td><input type="text" class="cell-input" id="colC" placeholder="聯絡人頁面"></td>
                  <td><input type="text" class="cell-input" id="colD"></td>
                  <td><input type="text" class="cell-input" id="colE" placeholder="顧問組別-姓名"></td>
                  <td><input type="text" class="cell-input" id="colF" placeholder="學生名單"></td>
                  <td><input type="text" class="cell-input" id="colG" placeholder="客戶名稱"></td>
                  <td><input type="text" class="cell-input" id="colH"></td>
                  <td><input type="text" class="cell-input" id="colI"></td>
                  <td><input type="text" class="cell-input" id="colJ"></td>
                  <td><input type="text" class="cell-input" id="colK"></td>
                  <td><input type="text" class="cell-input" id="colL"></td>
                  <td><input type="text" class="cell-input" id="colM" placeholder="金額"></td>
                  <td class="ocid-cell">
                    <select id="ocidSelect" class="ocid-select">
                      <option value="">無對應ID</option>
                    </select>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- iframe Container -->
        <div class="panel iframe-container">
          <div class="iframe-content">
            <iframe id="orderFrame" src="about:blank"></iframe>
          </div>
          <div class="iframe-footer">
            <div class="iframe-link">
              <strong>OneClass商品訂單連結:</strong>
              <span id="orderLink" class="text-gray-500">無可用連結</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Token 處理函式 =====
    async function fetchWithTokenRetry(url, options = {}, retryCount = 1) {
      try {
        let token = window.userToken;
        if (!token && window.auth?.currentUser) {
          token = await window.auth.currentUser.getIdToken();
          window.userToken = token;
        }

        const headers = {
          ...options.headers,
          'Authorization': `Bearer ${token}`
        };

        const response = await fetch(url, {
          ...options,
          headers
        });

        if (response.status === 401 && retryCount > 0 && window.auth?.currentUser) {
          console.log('Token 可能過期，嘗試更新...');
          const newToken = await window.auth.currentUser.getIdToken(true);
          window.userToken = newToken;
          return fetchWithTokenRetry(url, options, retryCount - 1);
        }

        return response;
      } catch (error) {
        console.error('fetchWithTokenRetry 錯誤:', error);
        throw error;
      }
    }

    // State management
    let sheetData = {
      colA: "",
      colB: "",
      colC: "",
      colD: "",
      colE: "",
      colF: "",
      colG: "",
      colH: "",
      colI: "",
      colJ: "",
      colK: "",
      colL: "",
      colM: "",
    }
    let oneClubCustomers = []
    let selectedOneClubId = ""
    let studentData = [];  // 儲存學生詳細資料
    let currentDealResult = null; // 儲存最新的 API 回應

    // Constants
    const NETLIFY_SITE_URL = "https://stirring-pothos-28253d.netlify.app"
    const EDUCATION_MAP = {
      'K': '幼稚園',
      'E': '國小',
      'J': '國中',
      'H': '高中'
    };
    
    async function updateTutorData() {
      // Tutor 資料已在 currentDealResult 中，根據選擇的 OCID 重新取得
      if (selectedOneClubId && currentDealResult?.raw?.tutor?.name) {
        sheetData.colK = currentDealResult.raw.tutor.name;
        document.getElementById("colK").value = sheetData.colK;
        // Update the big sheet's tutor field if available
        const bigSheetContainer = document.getElementById("bigSheetContainer");
        if (bigSheetContainer) {
          const newCol1 = bigSheetContainer.querySelector("#newCol1");
          if (newCol1) {
            newCol1.value = sheetData.colK;
          }
        }
      }
    }

    const GRADE_MAP = {
      'K': {
        '1': '',
        '2': '',
        '3': ''
      },
      'E': {
        '1': '一年級',
        '2': '二年級',
        '3': '三年級',
        '4': '四年級',
        '5': '五年級',
        '6': '六年級'
      },
      'J': {
        '1': '一年級',
        '2': '二年級',
        '3': '三年級'
      },
      'H': {
        '1': '一年級',
        '2': '二年級',
        '3': '三年級'
      }
    };

    // DOM Elements
    const dealIdInput = document.getElementById("dealId")
    const searchButton = document.getElementById("searchButton")
    const resultPre = document.getElementById("result")
    const linksContainer = document.getElementById("linksContainer")
    const copyButton = document.getElementById("copyButton")
    const orderFrame = document.getElementById("orderFrame")
    const orderLinkSpan = document.getElementById("orderLink")
    const ocidSelect = document.getElementById("ocidSelect")

    // Initialize input handlers
    Object.keys(sheetData).forEach((key) => {
      const input = document.getElementById(key)
      if (input) {
        input.addEventListener("change", (e) => {
          sheetData[key] = e.target.value
        })
      }
    })

    // Event Listeners
    dealIdInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        fetchDealInfo()
      }
    })

    searchButton.addEventListener("click", fetchDealInfo)
    copyButton.addEventListener("click", copySheetData)
    ocidSelect.addEventListener("change", (e) => {
      selectedOneClubId = e.target.value;
      
      // If the big sheet exists, synchronize its OCID
      const bigSheetContainer = document.getElementById("bigSheetContainer");
      if (bigSheetContainer) {
        const newCol2 = bigSheetContainer.querySelector("#newCol2");
        if (newCol2) {
          newCol2.value = e.target.value;
        }
      }
      
      // Update tutor data (輔導) based on the new OCID
      updateTutorData();
    });

    // Functions - 使用新的 DealClient
    async function fetchDealInfo() {
      const cleanDealId = dealIdInput.value.trim().replace(/[^A-Za-z0-9]/g, "")
      dealIdInput.value = cleanDealId

      if (!cleanDealId) {
        resultPre.textContent = "請輸入有效的交易編號!"
        return
      }

      searchButton.disabled = true
      resultPre.textContent = "查詢中..."
      clearSheetFields()
      linksContainer.innerHTML = ""

      // 移除既有的訂單選擇器
      const existingSelector = document.querySelector(".link-selector");
      if (existingSelector) existingSelector.remove();

      try {
        // 使用 DealClient 取得整合資料
        if (window.dealClient) {
          window.dealClient.setToken(window.userToken);
        }
        const result = await window.dealClient.fetchDealInfo(cleanDealId);
        
        if (!result.success) {
          throw new Error(result.error || 'API 回傳失敗');
        }

        // 儲存結果供後續使用
        currentDealResult = result;

        // 從 computed 直接取得已計算好的欄位資料
        const newSheetData = {
          colA: result.computed.payDate || "",
          colB: result.computed.dealId || "",
          colC: result.computed.contactUrl || "",
          colD: result.computed.status || "",
          colE: result.computed.advisor || "",
          colF: result.computed.students || "",
          colG: result.computed.contractor || "",
          colH: result.computed.subject || "",
          colI: result.computed.plan || "",
          colJ: result.computed.colJ || "",
          colK: result.computed.tutor || "",
          colL: result.computed.group || "",
          colM: result.computed.amount || ""
        };

        // 從 derived 取得衍生資料
        const { students, orderLinks, notes } = result.derived;
        
        // 儲存學生資料
        studentData = students.map(s => ({
          name: s.name,
          education: s.education,
          grade: s.grade
        }));

        // 更新 UI
        updateSheetData(newSheetData);
        resultPre.textContent = `【備註】\n${notes}`;

        // 處理 OneClub 客戶
        const customers = result.raw?.customers || [];
        if (result.computed.oneClubId) {
          updateOneClubCustomers(customers.length ? customers : [{
            oneClubId: result.computed.oneClubId,
            name: result.computed.contractor
          }]);
        } else {
          updateOneClubCustomers(customers);
        }

        // 處理訂單連結
        const dealLink = `https://oneclass.bitrix24.com/crm/deal/details/${cleanDealId}/`;
        const contactId = result.raw?.deal?.CONTACT_ID || "";
        
        // 建立連結按鈕
        linksContainer.innerHTML = "";
        const tradeButton = document.createElement("button");
        tradeButton.textContent = `交編 #${cleanDealId}`;
        tradeButton.onclick = () => window.open(dealLink, "_blank");
        linksContainer.appendChild(tradeButton);
        
        if (contactId) {
          const contactButton = document.createElement("button");
          contactButton.textContent = `聯絡人 ${contactId}`;
          contactButton.onclick = () => window.open(result.computed.contactUrl, "_blank");
          linksContainer.appendChild(contactButton);
        }

        // 處理訂單 iframe
        if (orderLinks.length > 0) {
          orderFrame.src = orderLinks[0];
          updateOrderLink(orderLinks[0]);
          
          // 若有多個訂單連結，建立選擇器
          if (orderLinks.length > 1) {
            const linkSelectorDiv = document.createElement("div");
            linkSelectorDiv.className = "link-selector";
            linkSelectorDiv.style.marginBottom = "10px";
            
            orderLinks.forEach((link, idx) => {
              const btn = document.createElement("button");
              btn.textContent = `訂單${idx === 0 ? '一' : '二'}`;
              btn.className = `button button-small${idx === 0 ? ' active-link' : ''}`;
              btn.style.marginRight = "5px";
              btn.onclick = () => {
                orderFrame.src = link;
                updateOrderLink(link);
                linkSelectorDiv.querySelectorAll('button').forEach((b, i) => {
                  b.className = `button button-small${i === idx ? ' active-link' : ''}`;
                });
              };
              linkSelectorDiv.appendChild(btn);
            });
            
            document.querySelector(".iframe-footer").insertAdjacentElement("beforebegin", linkSelectorDiv);
          }
        } else {
          orderFrame.src = "about:blank";
          updateOrderLink("無可用連結");
        }

        // 顯示警告訊息
        if (result.meta?.warnings?.length) {
          console.warn('API 警告:', result.meta.warnings);
        }

        // 顯示效能資訊
        if (result.meta?.timing) {
          console.log('API 耗時:', result.meta.timing);
        }

      } catch (err) {
        resultPre.textContent = "錯誤：" + err.message;
      } finally {
        searchButton.disabled = false;
      }
    }

    // 已移除 fetchOrderData 及 quotation 處理函式 - 這些邏輯已移至 Edge Function
    
    function clearSheetFields() {
      const emptyData = {
        colA: "",
        colB: "",
        colC: "",
        colD: "",
        colE: "",
        colF: "",
        colG: "",
        colH: "",
        colI: "",
        colJ: "",
        colK: "",
        colL: "",
        colM: "",
      }
      updateSheetData(emptyData)
      updateOneClubCustomers([])
      
      // 清除成交表資料
      const bigSheetContainer = document.getElementById("bigSheetContainer")
      if (bigSheetContainer) {
        bigSheetContainer.remove()
      }
    }

    function updateSheetData(newData) {
      sheetData = newData
      Object.keys(newData).forEach((key) => {
        const input = document.getElementById(key)
        if (input) {
          input.value = newData[key]
        }
      })
    }

    function updateOneClubCustomers(customers) {
      oneClubCustomers = customers
      ocidSelect.innerHTML = ""
      if (customers.length === 0) {
        ocidSelect.innerHTML = '<option value="">無對應ID</option>'
      } else {
        customers.forEach((customer) => {
          const option = document.createElement("option")
          option.value = customer.oneClubId || ""
          option.textContent = `${customer.name} (${customer.oneClubId || "?"})`
          ocidSelect.appendChild(option)
        })
        selectedOneClubId = customers[0]?.oneClubId || ""
      }
    }

    function updateOrderLink(link) {
      if (link && link !== "無可用連結") {
        const displayLink = link.length > 50 ? link.substring(0, 50) + "..." : link
        orderLinkSpan.innerHTML = `<a href="${link}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                ${displayLink}
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 016-2h6"/>
                    <path d="M15 3h6v6"/>
                    <path d="M10 14L21 3"/>
                </svg>
            </a>`
      } else {
        orderLinkSpan.textContent = "無可用連結"
      }
    }

    function copySheetData() {
      const rowData = []
      // A 到 L 欄位
      for (let c = "A".charCodeAt(0); c <= "L".charCodeAt(0); c++) {
        const colId = "col" + String.fromCharCode(c)
        let val = sheetData[colId] || ""
        val = val.replace(/\r?\n/g, " / ")
        rowData.push(val)
      }
      // M 欄位
      rowData.push(sheetData.colM || "")
      // N 欄 (OneClub ID) - 加上單引號確保數字格式
      rowData.push(selectedOneClubId ? `${selectedOneClubId}` : "")
      const tsvLine = rowData.join("\t")
      navigator.clipboard
        .writeText(tsvLine)
        .then(() => {
          alert("已複製 A~N 欄位到剪貼簿！")
        })
        .catch((err) => {
          console.error("複製失敗:", err)
          const temp = document.createElement("textarea")
          temp.value = tsvLine
          document.body.appendChild(temp)
          temp.select()
          document.execCommand("copy")
          document.body.removeChild(temp)
          alert("已複製 A~N 欄位到剪貼簿！")
        })
    }

document.addEventListener("DOMContentLoaded", function() {
  // 取得所有標頭 th
  const headerCells = document.querySelectorAll('table.data-table thead th');
  headerCells.forEach((th, index) => {
    // 建立 overlay div
    const overlay = document.createElement("div");
    overlay.className = "copy-overlay";
    // 加入 data-index 屬性，方便後續對應欄位
    overlay.setAttribute("data-index", index);
    // 確保 th 為 relative 定位（CSS 中也可設定）
    th.style.position = "relative";
    th.appendChild(overlay);

    // 綁定點擊事件
    overlay.addEventListener("click", function(e) {
      const idx = parseInt(e.currentTarget.getAttribute("data-index"));
      // 假設資料列有 id="dataRow"，取得該列的所有儲存格
      const dataRow = document.getElementById("dataRow");
      if (!dataRow) return;
      const cells = dataRow.children;
      if (idx >= cells.length) return;
      const targetCell = cells[idx];

      // 嘗試取得內部的 input 或 select 元素
      let value = "";
      const inputElement = targetCell.querySelector("input, select");
      if (inputElement) {
        value = inputElement.value;
        // 檢查是否為 OCID 欄位
        if (targetCell.querySelector("#newCol2")) {
          value = value ? `${value}` : "";
        }
      } else {
        value = targetCell.textContent.trim();
      }

      // 複製值到剪貼簿（支援 Chrome 與 Safari）
      navigator.clipboard.writeText(value)
        .then(() => {
          // 複製成功後，加入變色效果
          overlay.classList.add("copied");
          // 1.5秒後移除效果
          setTimeout(() => {
            overlay.classList.remove("copied");
          }, 520);
        })
        .catch((err) => {
          console.error("複製失敗:", err);
          // 備援方案：利用 textarea 複製
          const temp = document.createElement("textarea");
          temp.value = value;
          document.body.appendChild(temp);
          temp.select();
          document.execCommand("copy");
          document.body.removeChild(temp);
          // 備援方案同樣套用視覺效果
          overlay.classList.add("copied");
          setTimeout(() => {
            overlay.classList.remove("copied");
          }, 520);
        });
    });
  });
});

  // 取得【生成】按鈕參考
  const generateButton = document.getElementById("generateButton");
  
  generateButton.addEventListener("click", () => {
    // 先清除現有的成交表資料
    const existingContainer = document.getElementById("bigSheetContainer");
    if (existingContainer) {
      existingContainer.remove();
    }

    // 建立新的版位容器，id 設為 bigSheetContainer
    const bigSheetContainer = document.createElement("div");
    bigSheetContainer.id = "bigSheetContainer";
    bigSheetContainer.className = "panel table-container"; // 共用相同樣式，max-height已設定為100px

    // 產生標題與按鈕區塊
    bigSheetContainer.innerHTML = `
      <div class="table-header">
        <h2 class="table-title">成交大表資料</h2>
        <div class="table-actions">
          <button class="button button-primary" id="copyButton2">
            複製
          </button>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>輔導</th>
              <th>OCID</th>
              <th>成員</th>
              <th>學制</th>
              <th>年級</th>
              <th>立約人</th>
              <th>交編</th>
            </tr>
          </thead>
          <tbody>
            <tr id="dataRow2">
              <td><input type="text" class="cell-input" id="newCol1" value="${sheetData.colK || ''}" placeholder="輔導"></td>
              <td><input type="text" class="cell-input" id="newCol2" value="${ocidSelect.value || ''}" placeholder="OCID"></td>
              <td>
                <select id="newCol3" class="cell-input">
                  ${studentData.map(s => 
                    `<option value="${s.name}" data-education="${s.education}" data-grade="${s.grade}">${s.name}</option>`
                  ).join('') || '<option value="">無成員資料</option>'}
                </select>
              </td>
              <td><input type="text" class="cell-input" id="newCol4" readonly></td>
              <td><input type="text" class="cell-input" id="newCol5" readonly></td>
              <td><input type="text" class="cell-input" id="newCol6" value="${sheetData.colG || ''}" placeholder="立約人"></td>
              <td><input type="text" class="cell-input" id="newCol7" value="${sheetData.colB || ''}" placeholder="交編"></td>
            </tr>
          </tbody>
        </table>
      </div>
    `;

    // 為成員選單添加切換事件
    const newCol3 = bigSheetContainer.querySelector("#newCol3");
    const newCol4 = bigSheetContainer.querySelector("#newCol4");
    const newCol5 = bigSheetContainer.querySelector("#newCol5");
    
    newCol3.addEventListener("change", function() {
      const selectedOption = this.options[this.selectedIndex];
      const education = selectedOption.dataset.education;
      const grade = selectedOption.dataset.grade;
      
      // 更新學制和年級
      newCol4.value = EDUCATION_MAP[education] || '';
      newCol5.value = GRADE_MAP[education]?.[grade] || '';
      
      // 複製選中的學生名稱
      navigator.clipboard.writeText(this.value);
    });

    // 初始觸發一次 change 事件以設定初始值
    if (newCol3.options.length > 0) {
      newCol3.dispatchEvent(new Event('change'));
    }

    // 插入新版成交大表至 .panel-container 內
    document.querySelector(".panel-container").insertAdjacentElement("beforeend", bigSheetContainer);

    // 為新版位的表格標頭新增 overlay 複製功能（可複製單一欄位內容）
    addCopyOverlay(bigSheetContainer);

    // 新版位複製按鈕處理
    const copyButton2 = document.getElementById("copyButton2");

    copyButton2.addEventListener("click", () => {
      const dataRow = document.getElementById("dataRow2");
      const inputs = dataRow.querySelectorAll("input, select");
      const rowData = [];
      inputs.forEach((input, index) => {
        let value = input.value.trim();
        // 檢查是否為 OCID 欄位（index === 1）
        if (index === 1 && value) {
          value = `${value}`; // 加上單引號
        }
        rowData.push(value);
      });
      const tsvLine = rowData.join("\t");
      navigator.clipboard.writeText(tsvLine).then(() => {
        alert("已複製成交大表資料的內容！");
      });
    });

    // 在生成表格後添加 newCol1 的值變化監聽
    const newCol1 = bigSheetContainer.querySelector("#newCol1");
    const colK = document.getElementById("colK");
    
    if (newCol1 && colK) {
      // 監聽 input 事件以即時捕獲變化
      newCol1.addEventListener("input", function(e) {
        const newValue = e.target.value;
        // 如果新值不為空且與 colK 當前值不同，則更新 colK
        if (newValue && newValue !== colK.value) {
          colK.value = newValue;
          // 同時更新 sheetData
          sheetData.colK = newValue;
        }
      });
    }
  });

  // 依照原版邏輯，為指定容器中的每個表頭新增 overlay 複製功能
  function addCopyOverlay(container) {
    const headerCells = container.querySelectorAll("table.data-table thead th");
    headerCells.forEach((th, index) => {
      const overlay = document.createElement("div");
      overlay.className = "copy-overlay";
      overlay.setAttribute("data-index", index);
      th.style.position = "relative";
      th.appendChild(overlay);

      overlay.addEventListener("click", function(e) {
        const idx = parseInt(e.currentTarget.getAttribute("data-index"));
        // 取得對應 row 的所有儲存格
        const dataRow = container.querySelector("tbody tr");
        if (!dataRow) return;
        const cells = dataRow.children;
        if (idx >= cells.length) return;
        const targetCell = cells[idx];
        let value = "";
        const inputElement = targetCell.querySelector("input, select");
        if (inputElement) {
          value = inputElement.value;
          // 檢查是否為 OCID 欄位
          if (targetCell.querySelector("#newCol2")) {
            value = value ? `${value}` : "";
          }
        } else {
          value = targetCell.textContent.trim();
        }
        navigator.clipboard.writeText(value)
          .then(() => {
            overlay.classList.add("copied");
            setTimeout(() => {
              overlay.classList.remove("copied");
            }, 520);
          })
          .catch(() => {
            const temp = document.createElement("textarea");
            temp.value = value;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand("copy");
            document.body.removeChild(temp);
            overlay.classList.add("copied");
            setTimeout(() => {
              overlay.classList.remove("copied");
            }, 520);
          });
      });
    });
  }
  document.getElementById("helpButton").addEventListener("click", function() {
  window.open("TESTwhosthere.html", "HelpPopup", "width=650,height=700");
});

  </script>
</body>
</html>